---
title: "Modeller"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, echo=FALSE, message=FALSE}
suppressPackageStartupMessages({
  library(tidyverse)
  library(lubridate)
  library(modelr)
  library(broom)
  library(lmtest)
  library(sandwich)
  library(viridis)
})
# Chunkopsjoner nedenfor er til eget bruk

#knitr::opts_chunk$set(echo = FALSE, include = FALSE)
```

```{r}
# Jeg leser fra data mappen. Ser at det er en liten forskjell i størrelsen
# på de to csv filene
pm2 <- read_csv("data/pm2.csv",show_col_types = FALSE)

```

```{r mutatetogstring}
pm2 <- pm2 %>% 
  mutate(
    fnr = str_sub(knr, 1,2),
    aar_f = str_sub(aar)
  )
```

```{r serhead}
head(pm2)
```

```{r parsefactor}
pm2 %>% 
  mutate(
    fnr = parse_factor(fnr, levels = fnr),
    aar_f = parse_factor(aar_f, levels = aar_f)
  )
```

```{r mutateogselect}
pm2 <- pm2 %>% 
  mutate(
    Trade_pc_100K = Trade_p/100000
  ) 
```

```{r}

head(pm2, n = 4)
```

# Modell

```{r}
mod1 <- 'pm2 ~ aar_f + Total_ya_p + inc_k1 + inc_k5 + uni_k_mf + uni_l_mf + Trade_pc_100K'
```

```{r}

lm1 = lm(mod1, data = pm2)
```

```{r}
summary(lm1)
```

### ii

```{r}
pm2 %>%
  add_residuals(lm1)
```

### Residualene fra linær modell i datasettet pm2

```{r}
pm2 %>% 
  add_residuals(lm1)
head(pm2, n=4)
```

## Forklaring

### i

I år 2009 øker pm2 104, i 2010 med 908,..., i år 2017 øker pm2 med 5146.
Året 2009 er ikke signifikant, men koeffisientene er signifikante på 0.1% signifikansnivå fra 2010-2017.
Her forekommer økning i koeffisientene fra et år til neste.

## Heteroskedastisitet

### i.

```{r bptest}
bptest(lm1)
```

```{r}
# smart!
library(gvlma)
gvlma(lm1)
```

### iii.

```{r}
coeftest(lm1)
```

```{r}
vcovHC(lm1)
```

### iv.

```{r}
pm2 <- pm2 %>%
  add_residuals(lm1)
```

### v.

```{r}
pm2 <- pm2 %>%
  # må paste på "-01-01" for at date skal virke
  # make _date ser ut til å lage et datetime objekt
  # Vi trenger ikke tidspunkt ;-)
  mutate(aar_d = date(paste0(aar, "-01-01")))
```

### vi.

```{r}
pm2 <- pm2 %>%
  mutate(fylke = substr(knr, start = 1, stop = 2)) 


```

### vii og viii.

```{r}
pm2 %>%
  filter(fylke %in% c("01", "02", "03", "11", "12")) %>% 
  unnest(c(fylke)) %>%
  group_by(fylke, aar_d) %>%
  summarize(mean_fylke = mean(resid)
            ) %>% 
  ggplot(aes(x = aar_d, y = mean_fylke, colour = fylke)) +
  geom_line(lwd=1) +
  theme(legend.position = "bottom")+
  geom_hline(yintercept = 0, colour = "black")

```

# Dummy fylke og år

### i og ii.

Innfører en dummy for hvert fylke hvert år.
(Husk \* gir interaksjonsvariabler automatisk i Rs formula).
Bruk interaksjon mellom fnr og aar_f istedenfor aar_f.
La modell 2 ellers være lik modell 1.

```{r}
mod2 <- 'pm2 ~ aar_f*fnr + Total_ya_p + inc_k1 + inc_k5 + uni_k_mf + uni_l_mf + Trade_pc_100K'
lm2 <- lm(mod2, data = pm2)
summary(lm2)
```

### iii.

```{r}
pm2 <- pm2 %>%
  mutate(res_m2 = resid(lm2))
```

### iv.

Delplott

```{r}
pm2 %>% filter(fnr %in% c("01", "02", "04", "11", "12")) %>%
ggplot(mapping = aes(x = aar_d, y = res_m2)) +
geom_line(aes(group = knavn)) +
scale_size_manual(values = c(seq(2.0, 0.5, by = -0.1))) +
geom_hline(yintercept = 0) +
theme(legend.position = 'bottom') +
  facet_wrap(~fylke)
```

### i, ii.

Kvaliteten på modellen er ikke helt optimal da den mangler noen variabler.
Dette kan ha noe med heteroskedatisitet i modell at det er stor variasjon.
Det er store residualer, spesielt i Rogaland.

### iii.

```{r}


pm2 %>% filter(fnr %in% c("11")) %>%
ggplot(mapping = aes(x = aar_d, y = res_m2)) +
scale_color_viridis(discrete = TRUE, option = "D") +
geom_line(aes(group = knavn, colour = knavn, size =knavn)) +
scale_size_manual(values = c(seq(2.0, 0.5, by = -0.1))) +
geom_hline(yintercept = 0) +
theme(legend.position = 'bottom')
```

Det er ikke stor nok fargeskala for alle kommunene.

#i.

```{r}
pm2 %>% filter(knr %in% c("1119", "1120", "1127", "1121", "1130", "1135", "1106", "1149")) %>%
ggplot(mapping = aes(x = aar_d, y = res_m2)) +
scale_color_viridis(discrete = TRUE, option = "H") +
geom_line(aes(group = knavn, colour = knavn, size =knavn)) +
scale_size_manual(values = c(seq(2.0, 0.5, by = -0.1))) +
geom_hline(yintercept = 0) +
theme(legend.position = 'bottom')
```

# ii.

De som ligger nærmere Stavanger overvurderes.

# Modell for hvert år

```{r}
pm2_n <- pm2 %>% 
  # tar med aar_d. Velger først variablene
  select(pm2, fnr, knr, aar, aar_f, aar_d, Menn_ya_p, Kvinner_ya_p, Total_ya_p, inc_k1, inc_k5, uni_k_mf, uni_l_mf, Trade_pc_100K) %>% 
  group_by(aar) %>%
  nest()
```

```{r}
pm2_n
```

```{r}
pm2_n$data[[1]] %>%
head(n = 5)
```

```{r}
dim(pm2_n)
```

```{r}
# data må være lik a_df som er argumentet
kom_model <- function(a_df) {
  lm(pm2 ~ fnr + Total_ya_p + inc_k1 + inc_k5 + uni_k_mf + uni_l_mf + Trade_pc_100K, data = a_df)
}
```

```{r}
pm2_n <- pm2_n %>% 
  mutate(model = map(data, .f = kom_model)) 
```

```{r}
# kom_model(pm2_n$aar) %>% 
#   summary()
```

```{r}
pm2_n %>% 
  filter(aar%in% c("2008")) %>% 
  .$model %>% 
  map_df(glance) %>% 
  print()
```

```{r}
mod_sum <- pm2_n %>% 
  # filter(aar %in% c("2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017")) %>% 
  mutate(mod_summary = map(.x = model, .f = glance)) %>% 
  unnest(mod_summary) %>% 
  print()
```

```{r}
# Plukker ut modeeellen
coef_df <- mod_sum$model %>% 
  # 1 henter ut koeffisientene, 2 residualene etc.
  map_df(1) %>% 
  # trenger ikke endre til tibble, bare si at vi ønsker en tibble
  tibble()
```

## Den siste delen mangler

Her er min kode for avslutningen.

i\.
Lag en ny variabel av type date i `coef_df` som angir år.

```{r}

coef_df <- coef_df %>%

mutate(

aar = ymd(paste(2008:2017, "-01-01", sep = ""))

) %>%

select(aar, everything())

```

i.  Pivot_longer `coef_df` til `coef_df_long.`

```{r}

coef_df_long <- coef_df %>%

pivot_longer(

cols = `(Intercept)`:`Trade_pc_100K`,

names_to = "variables",

values_to = "coef"

)

```

i.  Lag så et plot av fylke-faktorvariablenes koeffisienter for fylkene "fnr02", "fnr03", "fnr04", "fnr10", "fnr11", "fnr12", "fnr14" fra år 2008 til 2017.

ii. Hva sier plot-et oss om prisutviklingen i disse fylkene?

iii. Hva skjedde i 2014?

Her er kode for å lage plottet:

```{r, echo = TRUE, include = TRUE}

coef_df_long %>%

select(aar, variables, coef) %>%

filter(

variables %in% c("fnr02", "fnr03", "fnr04", "fnr10", "fnr11", "fnr12", "fnr14")

) %>%

ggplot(mapping = aes(x = aar, y = coef, colour = variables)) +

scale_color_viridis(discrete = TRUE, option = "D") +

geom_line(aes(group = variables), lwd = 1) +

theme(legend.position = 'bottom')

```

i.  Lag et plot tilsvarende det ovenfor for fnr, men nå for variablene Total_ya_p, inc_k1, inc_k5, uni_k\_mf, uni_l\_mf og Trade_pc_100K.
    (Plottet er gjengitt nedenfor, dere skal gjenskape det vha ggplot)

ii. Diskuter om koeffisientene ser ut til å være stabile over tid.

```{r, include = TRUE}
coef_df_long %>%
select(aar, variables, coef) %>%
filter(variables %in% c("Total_ya_p", "inc_k1", "inc_k5",
"uni_k_mf", "uni_l_mf", "Trade_pc_100K")
) %>%
ggplot(
  mapping = aes(x = aar, y = coef, colour = variables)
  ) +
scale_color_viridis(discrete = TRUE, option = "D") +
geom_line(aes(group = variables), lwd = 1) +
theme(legend.position = 'bottom')
```

```{r}
#siste
```
